import os
import json
import replicate
import logging
from aiogram import Bot, Dispatcher
from aiogram.filters import Command
from aiogram.types import Message
from aiogram import Router
from dotenv import load_dotenv
from aiogram.types import FSInputFile

logging.basicConfig(level=logging.INFO)

load_dotenv()

# –¢–æ–∫–µ–Ω—ã
BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
REPLICATE_API_TOKEN = os.getenv("REPLICATE_API_TOKEN")

if not BOT_TOKEN or not REPLICATE_API_TOKEN:
    raise ValueError("–£–∫–∞–∂–∏—Ç–µ TELEGRAM_BOT_TOKEN –∏ REPLICATE_API_TOKEN –≤ .env")

os.environ["REPLICATE_API_TOKEN"] = REPLICATE_API_TOKEN


with open("BdDt.json", "r", encoding="utf-8") as f:
    DB_SCHEMA = json.dumps(json.load(f), ensure_ascii=False)


bot = Bot(token=BOT_TOKEN)
dp = Dispatcher()
router = Router()


def generate_sql(user_query: str) -> str:
    SYSTEM_RULES = """–¢—ã ‚Äî —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π.
–ì–µ–Ω–µ—Ä–∏—Ä—É–π –¢–û–õ–¨–ö–û –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π SQL –¥–ª—è SQLite.

–ñ–Å–°–¢–ö–ò–ï –ü–†–ê–í–ò–õ–ê:
1. –¢–æ–ª—å–∫–æ SELECT
2. –¢–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–∞–±–ª–∏—Ü—ã –∏ –ø–æ–ª—è
3. JOIN –¢–û–õ–¨–ö–û –ø–æ G071, G072, G073
4. –ë–µ–∑ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
5. –ë–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
6. –ß–∏—Å–ª–∞ ‚Üí CAST(... AS REAL)
7. dclplatr –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –µ—Å–ª–∏ –µ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∏
8. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø–æ–ª—è, –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–µ–π —Ç–∞–±–ª–∏—Ü—ã
9. –í —Ç–∞–±–ª–∏—Ü–µ dcltrans –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω—ã—Ö —Å—Ä–µ–¥—Å—Ç–≤ ‚Äî –∏—Å–ø–æ–ª—å–∑—É–π –¢–û–õ–¨–ö–û VIDTRANS
10. –ü–æ–ª—è dcltovar (G31_*, G33, G35, G37, G38, G46) –æ—Ç–Ω–æ—Å—è—Ç—Å—è –¢–û–õ–¨–ö–û –∫ —Ç–æ–≤–∞—Ä—É
11. –õ—é–±–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ –±–µ—Ä—ë—Ç—Å—è –¢–û–õ–¨–ö–û –∏–∑ dcltrans
12. –ü—Ä–∏–∑–Ω–∞–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–Ω—ã—Ö –ø–µ—Ä–µ–≤–æ–∑–æ–∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û dcltrans.G19
13. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç–æ–≤—ã–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏—è –±–µ–∑ —Å–ø—Ä–∞–≤–æ—á–Ω–∏–∫–æ–≤
14. CASE –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –ø—Ä–∏ —è–≤–Ω–æ–º —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
15. –í—Å–µ –Ω–µ–∞–≥—Ä–µ–≥–∞—Ç–Ω—ã–µ –ø–æ–ª—è –∏–∑ SELECT –û–ë–Ø–ó–ê–¢–ï–õ–¨–ù–û —É–∫–∞–∑—ã–≤–∞—Ç—å –≤ GROUP BY
16. LIKE –∏ SUBSTR –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¢–û–õ–¨–ö–û –¥–ª—è –∫–æ–¥–æ–≤—ã—Ö –ø–æ–ª–µ–π
17. –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—à–µ–Ω–æ –ø–æ–ª–µ –∏–ª–∏ —Å–º—ã—Å–ª, –∫–æ—Ç–æ—Ä–æ–≥–æ –Ω–µ—Ç –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä–µ –ë–î,
    –ó–ê–ü–†–ï–©–ï–ù–û —Å–æ–∑–¥–∞–≤–∞—Ç—å –∏–ª–∏ —É–≥–∞–¥—ã–≤–∞—Ç—å –ø–æ–ª—è.
    –í —ç—Ç–æ–º —Å–ª—É—á–∞–µ –≤–æ–∑–≤—Ä–∞—â–∞–π –¢–û–õ–¨–ö–û –¥–æ—Å—Ç—É–ø–Ω—ã–µ –ø–æ–ª—è.

18. –í —Ç–∞–±–ª–∏—Ü–µ dcltrans —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –¢–û–õ–¨–ö–û –ø–æ–ª–µ VIDTRANS.
    –õ—é–±—ã–µ NAIMTRANS, NAME, TITLE, DESCRIPTION –ó–ê–ü–†–ï–©–ï–ù–´.

19. –ü–æ–Ω—è—Ç–∏–µ ¬´–Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≤–∏–¥–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–Ω–æ–≥–æ —Å—Ä–µ–¥—Å—Ç–≤–∞¬ª
    –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –≤ –ë–î –∏ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –≤–æ–∑–≤—Ä–∞—â–µ–Ω–æ.
20. –¢–µ—Ä–º–∏–Ω ¬´–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–æ–≤ (–≤ —à—Ç.)¬ª –æ–∑–Ω–∞—á–∞–µ—Ç
    –¢–û–õ–¨–ö–û SUM(CAST(dcltovar.G31_2 AS REAL)).
    COUNT(*) –ó–ê–ü–†–ï–©–ï–ù–û –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–æ–≤.
21. COUNT(*) —Ä–∞–∑—Ä–µ—à—ë–Ω –¢–û–õ–¨–ö–û –¥–ª—è:
    - –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π
    - –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ç–æ–≤–∞—Ä–Ω—ã—Ö –ø–æ–∑–∏—Ü–∏–π

22. –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π = COUNT(DISTINCT dclhead.G073)
23. –ó–∞–ø—Ä–µ—â–µ–Ω–æ –¥–µ–ª–∏—Ç—å —Ä–∞–∑–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏:
    - —Ç–æ–≤–∞—Ä—ã / –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
    - –ø–æ–∑–∏—Ü–∏–∏ / –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–∏
    - —Ç–æ–≤–∞—Ä—ã / –ø–æ–∑–∏—Ü–∏–∏
    –ß–∏—Å–ª–∏—Ç–µ–ª—å –∏ –∑–Ω–∞–º–µ–Ω–∞—Ç–µ–ª—å –î–û–õ–ñ–ù–´ –±—ã—Ç—å –æ–¥–Ω–æ–π –ø—Ä–∏—Ä–æ–¥—ã.


"""

    SCHEMA_BLOCK = f"""–°–¢–†–£–ö–¢–£–†–ê –ë–ê–ó–´ –î–ê–ù–ù–´–•:
{DB_SCHEMA}"""

    EXAMPLES_BLOCK = """–ü–†–ò–ú–ï–†–´:

–ü—Ä–∏–º–µ—Ä 1 (–ø–ª–∞—Ç–µ–∂–∏):
–ó–∞–ø—Ä–æ—Å: —Å—É–º–º–∞ –Ω–∞—á–∏—Å–ª–µ–Ω–Ω–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞ –¥–ª—è –ò—Ç–∞–ª–∏–∏ –Ω–∞ —Ç–∞–º–æ–∂–Ω–µ 10122*
SQL: SELECT SUM(CAST(p.G474 AS REAL)) FROM dclhead h JOIN dcltovar t ON h.G071=t.G071 AND h.G072=t.G072 AND h.G073=t.G073 JOIN dclplatr p ON t.G071=p.G071 AND t.G072=p.G072 AND t.G073=p.G073 WHERE h.G071 LIKE '10122%' AND t.G34='380';

–ü—Ä–∏–º–µ—Ä 2 (–ò–¢–°, –ë–ï–ó –ø–ª–∞—Ç–µ–∂–µ–π):
–ó–∞–ø—Ä–æ—Å: –ò–¢–° –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –Ω–∞ —Ç–∞–º–æ–∂–Ω–µ 10125020, –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≠–ö, –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ 10
SQL: SELECT SUBSTR(t.G33,1,4), t.G31_1, SUM(CAST(t.G38 AS REAL)), SUM(CAST(t.G46 AS REAL)), ROUND(SUM(CAST(t.G46 AS REAL))/NULLIF(SUM(CAST(t.G38 AS REAL)),0),2) FROM dclhead h JOIN dcltovar t ON h.G071=t.G071 AND h.G072=t.G072 AND h.G073=t.G073 WHERE h.G071='10125020' AND h.G011='–≠–ö' AND t.G37 LIKE '10%' GROUP BY 1,2;

–ü—Ä–∏–º–µ—Ä 3 (–∏—Ç–æ–≥–æ–≤—ã–µ —Å—É–º–º—ã —á–µ—Ä–µ–∑ –æ–∫–æ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏):
–ó–∞–ø—Ä–æ—Å: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –î–¢ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–¥—Å—É–±–ø–æ–∑–∏—Ü–∏–π "8702*" –∏ "8703*" –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–π –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä–µ –ï–¢–ù –í–≠–î, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –Ω–∞ –ú–æ—Å–∫–æ–≤—Å–∫–æ–π —Å–µ–≤–µ—Ä–Ω–æ–π —Ç–∞–º–æ–∂–Ω–µ (–∫–æ–¥ —Ç–∞–º–æ–∂–Ω–∏: "10123*") –≤ —Ä–µ–∂–∏–º–µ –ò–ú 40. –ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏: –∫–æ–¥ —Ç–æ–≤–∞—Ä–∞ –ø–æ –ï–¢–ù –í–≠–î; –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Å—É–±–ø–æ–∑–∏—Ü–∏–∏, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–≤–∞—Ä–∞ (–≤ —à—Ç.); –≤–µ—Å –Ω–µ—Ç—Ç–æ (–≤ –∫–≥); —Å—Ç–∞—Ç–∏—Å—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (–≤ –¥–æ–ª–ª–∞—Ä–∞—Ö –°–®–ê). –ü–æ–¥—Å—á–∏—Ç–∞—Ç—å —Å—É–º–º—ã.
SQL: SELECT
    t.G33 AS Kod_ETNVED,
    t.G31_1 AS Naimenovanie_Subpozicii,
    CAST(t.G31_2 AS REAL) AS Kolichestvo_sht,
    CAST(t.G38 AS REAL) AS Netto_kg,
    CAST(t.G46 AS REAL) AS Stat_Stoim_USD,
    SUM(CAST(t.G31_2 AS REAL)) OVER () AS Itogo_Kolichestvo_sht,
    SUM(CAST(t.G38 AS REAL)) OVER () AS Itogo_Netto_kg,
    SUM(CAST(t.G46 AS REAL)) OVER () AS Itogo_Stat_Stoim_USD
FROM DclTovar t
JOIN DclHead h
  ON t.G071 = h.G071 AND t.G072 = h.G072 AND t.G073 = h.G073
WHERE (t.G33 LIKE '8702%' OR t.G33 LIKE '8703%')
  AND h.G071 LIKE '10123%'
  AND h.G011 = '–ò–ú'
  AND h.G012 = '40';

–ü—Ä–∏–º–µ—Ä 4 (—Å—Ç—Ä–∞–Ω—ã —ç–∫—Å–ø–æ—Ä—Ç–∞ —Å CASE):
–ó–∞–ø—Ä–æ—Å: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –î–¢ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤, —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –≤ –°–®–ê –∏ –≤ –ì–µ—Ä–º–∞–Ω–∏—é, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –Ω–∞ –ù–æ–≤–æ–ª–∏–ø–µ—Ü–∫–æ–º —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º –ø–æ—Å—Ç—É (–∫–æ–¥ —Ç/–ø: 10109020). –†–µ–∑—É–ª—å—Ç–∞—Ç: —Å—Ç—Ä–∞–Ω–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ (–≤ –≤–∏–¥–µ '–°–®–ê' –∏–ª–∏ '–ì–µ—Ä–º–∞–Ω–∏—è'), –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π.
SQL: SELECT 
    CASE h.G11
        WHEN 'US' THEN '–°–®–ê'
        WHEN 'DE' THEN '–ì–µ—Ä–º–∞–Ω–∏—è'
        WHEN '840' THEN '–°–®–ê'
        WHEN '276' THEN '–ì–µ—Ä–º–∞–Ω–∏—è'
        ELSE h.G11
    END AS Strana_eksporta,
    COUNT(*) AS Kolichestvo_DT
FROM DclHead h
WHERE h.G011 = '–≠–ö'
  AND h.G071 = '10109020'
  AND h.G11 IN ('US', 'DE', '840', '276')
GROUP BY h.G11
ORDER BY Kolichestvo_DT DESC;


–ü—Ä–∏–º–µ—Ä 6 (EXISTS –¥–ª—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤):
–ó–∞–ø—Ä–æ—Å: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –î–¢ –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏ –¥–ª—è —Ç–æ–≤–∞—Ä–æ–≤, –ø–µ—Ä–µ–≤–µ–∑–µ–Ω–Ω—ã—Ö –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞—Ö –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ò–ú (–≠–ö), –ø—Ä–æ—Ü–µ–¥—É—Ä–∞–º–∏ 40 (10) –ø–æ –¥–∞–Ω–Ω—ã–º –û—Ä–ª–æ–≤—Å–∫–æ–π —Ç–∞–º–æ–∂–Ω–∏ (–∫–æ–¥ —Ç–∞–º–æ–∂–Ω–∏: "10117*"). –ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏: –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è, –≤–µ—Å –±—Ä—É—Ç—Ç–æ (–≤ —Ç–æ–Ω–Ω–∞—Ö).
SQL: SELECT
    h.G011 AS "–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è",
    SUM(CAST(COALESCE(t.G35, '0') AS REAL)) / 1000.0 AS "–í–µ—Å –±—Ä—É—Ç—Ç–æ, —Ç"
FROM DclHead h
JOIN DclTovar t
  ON h.G071 = t.G071 AND h.G072 = t.G072 AND h.G073 = t.G073
WHERE
    TRIM(h.G071) LIKE '10117%'
    AND h.G011 IN ('–ò–ú', '–≠–ö')
    AND SUBSTR(TRIM(t.G37), 1, 2) IN ('40','10')
    AND EXISTS (
        SELECT 1
        FROM DclTrans tr
        WHERE tr.G071 = h.G071 AND tr.G072 = h.G072 AND tr.G073 = h.G073
          AND TRIM(tr.G19) IN ('1','–î','–¥')
    )
GROUP BY h.G011
ORDER BY h.G011;

–ü—Ä–∏–º–µ—Ä 9 (–∞–≥—Ä–µ–≥–∞—Ü–∏—è –ø–æ 2 –∑–Ω–∞–∫–∞–º –¢–ù –í–≠–î):
–ó–∞–ø—Ä–æ—Å: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –ø–æ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –î–¢ –æ—Å–Ω–æ–≤–Ω—É—é –Ω–æ–º–µ–Ω–∫–ª–∞—Ç—É—Ä—É (–Ω–∞ —É—Ä–æ–≤–Ω–µ 2-—Ö –∑–Ω–∞–∫–æ–≤ –∫–æ–¥–∞ –ø–æ –ï–¢–ù –í–≠–î) —Ç–æ–≤–∞—Ä–æ–≤, –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã—Ö –Ω–∞ –õ–µ—Ñ–æ—Ä—Ç–æ–≤—Å–∫–æ–º —Ç–∞–º–æ–∂–µ–Ω–Ω–æ–º –ø–æ—Å—Ç—É (–∫–æ–¥ —Ç/–ø: 10124050) –≤ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Å –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ò–ú, –ø—Ä–æ—Ü–µ–¥—É—Ä–æ–π 40. –ü–æ–ª—É—á–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞–º–∏: –≥—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞ –ø–æ –ï–¢–ù –í–≠–î; –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã, –≤–µ—Å –Ω–µ—Ç—Ç–æ –ø–æ –≥—Ä—É–ø–ø–µ (–≤ –∫–≥).
SQL: SELECT
    SUBSTR(t.G33, 1, 2) AS "–ì—Ä—É–ø–ø–∞ —Ç–æ–≤–∞—Ä–∞ –ø–æ –ï–¢–ù –í–≠–î",
    t.G31_1 AS "–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–ø–ø—ã",
    SUM(CAST(COALESCE(t.G38, '0') AS REAL)) AS "–í–µ—Å –Ω–µ—Ç—Ç–æ –∫–≥"
FROM DclTovar t
JOIN DclHead h ON t.G071 = h.G071 AND t.G072 = h.G072 AND t.G073 = h.G073
WHERE h.G011 = '–ò–ú'
  AND h.G012 = '40'
  AND h.G071 = '10124050'
GROUP BY SUBSTR(t.G33, 1, 2), t.G31_1
ORDER BY "–í–µ—Å –Ω–µ—Ç—Ç–æ –∫–≥" DESC;"""

    USER_BLOCK = f"""–ó–ê–ü–†–û–° –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–Ø:
{user_query}

SQL:"""

    prompt = "\n\n".join([SYSTEM_RULES.strip(), SCHEMA_BLOCK.strip(), EXAMPLES_BLOCK.strip(), USER_BLOCK.strip()])

    output = replicate.run(
        "meta/meta-llama-3-70b-instruct",
        input={
            "prompt": prompt,
            "max_tokens": 512,
            "temperature": 0.01,
            "top_p": 0.9,
            "prompt_template": "<|begin_of_text|><|start_header_id|>user<|end_header_id|>\n\n{prompt}<|eot_id|><|start_header_id|>assistant<|end_header_id|>\n\n"
        }
    )
    return "".join(output).strip()


# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–æ–º–∞–Ω–¥—ã /start
@router.message(Command("start"))
async def start_handler(message: Message):
    photo = FSInputFile("marinka_gpt.png")  # ‚Üê –ª–æ–∫–∞–ª—å–Ω—ã–π –ø—É—Ç—å

    caption = (
        "üëã –Ø ‚Äî SQL-–∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö —Ç–∞–º–æ–∂–µ–Ω–Ω—ã—Ö –¥–µ–∫–ª–∞—Ä–∞—Ü–∏–π.\n\n"
        "–û—Ç–ø—Ä–∞–≤—å –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä—É—Å—Å–∫–æ–º ‚Äî –ø–æ–ª—É—á—É –≥–æ—Ç–æ–≤—ã–π SQL –¥–ª—è SQLite.\n\n"
    )

    await message.answer_photo(photo=photo, caption=caption)
    
# –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –õ–Æ–ë–û–ì–û —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è, –ö–†–û–ú–ï –∫–æ–º–∞–Ω–¥
@router.message()
async def handle_message(message: Message):
    if not message.text:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –æ—Ç–ø—Ä–∞–≤—å —Ç–µ–∫—Å—Ç–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å.")
        return

    logging.info(f"–ü–æ–ª—É—á–µ–Ω –∑–∞–ø—Ä–æ—Å: {message.text}")
    await message.answer("ü™Ñ –ì–µ–Ω–µ—Ä–∏—Ä—É—é SQL... (10‚Äì20 —Å–µ–∫)")

    try:
        sql = generate_sql(message.text)
        # –û—á–∏—â–∞–µ–º –æ—Ç –≤–æ–∑–º–æ–∂–Ω—ã—Ö –ª–∏—à–Ω–∏—Ö —Å–∏–º–≤–æ–ª–æ–≤
        if sql.startswith("```sql"):
            sql = sql[7:]
        if sql.endswith("```"):
            sql = sql[:-3]
        await message.answer(sql.strip())
    except Exception as e:
        await message.answer(f"‚ùå –û—à–∏–±–∫–∞: {str(e)}")


# –ó–∞–ø—É—Å–∫
async def main():
    dp.include_router(router)
    await bot.delete_webhook(drop_pending_updates=True)
    await dp.start_polling(bot)


if __name__ == "__main__":
    import asyncio
    asyncio.run(main())